---
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';
import { FaBriefcase, FaArrowRight } from '@/lib/icons';
import { getCollection } from 'astro:content';
import { createTechMap } from '@/utils/tech-lookup';
import { formatDateRange, calculateDuration } from '@/utils/date-format';
import Card from '@/components/molecules/Card.astro';
import TagList from '@/components/molecules/TagList.astro';
import ListItem from '@/components/molecules/ListItem.astro';
import Heading from '@/components/atoms/Heading.astro';
import Text from '@/components/atoms/Text.astro';
import Link from '@/components/atoms/Link.astro';
import Badge from '@/components/atoms/Badge.astro';
import Icon from '@/components/atoms/Icon.astro';

interface Props {
  role: {
    data: {
      title: string;
      slug: string;
      organization: string;
      location?: string;
      startDate: Date;
      endDate?: Date;
      current?: boolean;
      summary?: string;
      highlights: string[];
      achievements: string[];
      technologies: string[];
      isActive?: boolean;
    };
  };
  organization?: {
    data: {
      name: string;
      slug: string;
      logo?: ImageMetadata;
      website?: string;
      location?: string;
    };
  };
  showAllDetails?: boolean;
}

const { role, organization, showAllDetails = false } = Astro.props;

const technologies = await getCollection('technologies');
const techMap = createTechMap(technologies);

const duration = calculateDuration(role.data.startDate, role.data.endDate);
const dateRange = formatDateRange(role.data.startDate, role.data.endDate, role.data.current);
const orgName = organization?.data.name || role.data.organization;
const logoAlt = `${orgName.trim()} logo`;
---

<div id={role.data.slug}>
<Card variant="tactile" padding="base">
  <div class="mb-4 flex flex-col md:flex-row md:items-start md:justify-between">
    <div class="flex flex-col items-start gap-4 md:flex-row">
      <div class="bg-muted border-border flex aspect-square w-20 items-center justify-center overflow-hidden rounded border">
        {organization?.data.logo ? (
          <Image
            src={organization.data.logo}
            alt={logoAlt}
            loading="lazy"
            width={100}
            height={100}
          />
        ) : (
          <Icon icon={FaBriefcase} size="lg" color="muted" />
        )}
      </div>
      <div class="space-y-1">
        <Heading level={3} size="lg">{role.data.title}</Heading>
        <Heading level={4} size="base" class="text-secondary font-medium">
          {orgName}
          {organization?.data.website && (
            <a
              href={organization.data.website}
              target="_blank"
              rel="noopener noreferrer"
              class="text-secondary hover:text-secondary-hover transition-colors ml-1"
            >
              <FaArrowRight className="inline w-3 h-3" />
              <span class="sr-only">Visit Site</span>
            </a>
          )}
        </Heading>
        {role.data.location && (
          <Text size="sm" color="muted">{role.data.location}</Text>
        )}
      </div>
    </div>
    <div class="md:text-right mt-4 md:mt-0">
      <Text weight="medium" color="muted">{dateRange}</Text>
      <Text size="sm" color="muted" class="mt-1">{duration}</Text>
      {role.data.current && (
        <Badge label="Current" variant="secondary" size="sm" class="mt-1" />
      )}
    </div>
  </div>

  {showAllDetails && role.data.summary && (
    <div class="border-border mb-8 max-w-2xl rounded-md border p-4">
      <Text size="sm" color="muted">{role.data.summary}</Text>
    </div>
  )}

  <div class="grid gap-6 md:grid-cols-2">
    <div>
      <Heading level={5} size="base" class="mb-3">Highlights</Heading>
      <ul class="space-y-2">
        {role.data.highlights.slice(0, showAllDetails ? undefined : 3).map((highlight) => (
          <ListItem icon="check" iconColor="secondary">
            {highlight}
          </ListItem>
        ))}
      </ul>

      {!showAllDetails && (
        <div class="mt-4">
          <Link
            href={`/experience#${role.data.slug}`}
            variant="primary"
            size="sm"
            showArrow
          >
            See more details
          </Link>
        </div>
      )}
    </div>

    <div>
      <Heading level={5} size="base" class="mb-3">Technologies</Heading>
      <TagList
        tags={role.data.technologies}
        techMap={techMap}
        limit={showAllDetails ? undefined : 10}
      />

      {role.data.achievements.length > 0 && (
        <div class="mt-4">
          <Heading level={5} size="base" class="mb-2">Key Achievements</Heading>
          <ul class="space-y-1">
            {role.data.achievements.map((achievement) => (
              <ListItem icon="award" iconColor="secondary" size="sm">
                {achievement}
              </ListItem>
            ))}
          </ul>
        </div>
      )}
    </div>
  </div>
</Card>
</div>
