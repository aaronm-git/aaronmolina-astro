---
import MainLayout from '@/layouts/main-layout.astro';
import { getCollection, render } from 'astro:content';
import { Image } from 'astro:assets';
import { createTechMap, objectToTechMap } from '@/utils/tech-lookup';
import { FaGithub, FaArrowRight, FaArrowLeft } from '@/utils/icons';
import Button from '@/components/ui/Button.astro';
import TagList from '@/components/ui/TagList.astro';
import Tag from '@/components/ui/Tag.astro';
import InfoBox from '@/components/ui/InfoBox.astro';
import pages from '@/content/site/pages.json';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  const technologies = await getCollection('technologies');
  const techMap = createTechMap(technologies);

  return projects.map(p => ({
    params: { project: p.data.slug },
    props: { project: p, techMapObj: Object.fromEntries(techMap) },
  }));
}

const { project, techMapObj } = Astro.props;
const { Content } = await render(project);
const techMap = objectToTechMap(techMapObj);
---

<MainLayout title={project.data.title} description={project.data.summary}>
  <article class="mx-auto max-w-screen-lg">
    <!-- Back Navigation -->
    <nav class="mb-8">
      <a href="/projects" class="text-foreground-muted hover:text-foreground group inline-flex items-center gap-1 font-medium transition-colors">
        <FaArrowLeft className="icon-sm transition-transform group-hover:-translate-x-1" />
        Back to Projects
      </a>
    </nav>

    <!-- Project Header -->
    <header class="mb-12">
      <!-- Meta Info -->
      <div class="mb-6 flex flex-wrap items-center gap-3">
        {project.data.featured && (
          <Tag label="Featured" variant="featured" size="sm" />
        )}
        {
          project.data.completedOn && (
            <span class="text-foreground-muted inline-flex items-center gap-1.5 text-sm">
              {project.data.completedOn.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
              })}
            </span>
          )
        }
      </div>

      <!-- Title -->
      <h1 class="text-foreground mb-6 text-4xl leading-tight font-bold tracking-tight md:text-5xl lg:text-6xl">
        {project.data.title}
      </h1>

      <!-- Description -->
      {project.data.summary && <p class="text-foreground-muted mb-8 text-xl leading-relaxed md:text-2xl">{project.data.summary}</p>}

      <!-- Technologies -->
      {project.data.technologies.length > 0 && (
        <div class="mb-8">
          <TagList tags={project.data.technologies.slice(0, 8)} techMap={techMap} size="base" />
        </div>
      )}

      <!-- Action Buttons -->
      <div class="flex flex-wrap items-center gap-3">
        {project.data.liveUrl && (
          <Button href={project.data.liveUrl} variant="secondary" icon="arrowRight" iconPosition="right" external>
            Visit Live Project
          </Button>
        )}

        {project.data.repoUrl && (
          <Button href={project.data.repoUrl} variant="outline" external>
            <FaGithub className="icon-sm" />
            View Source
          </Button>
        )}

        <Button href="#project-details" variant="ghost" icon="info">
          More Details
        </Button>
      </div>

      <!-- Featured Image -->
      {
        project.data.featuredImage && (
          <div class="border-border mt-12 overflow-hidden rounded-xl border shadow-2xl">
            <Image src={project.data.featuredImage} alt={project.data.title} class="h-full w-full object-cover" loading="eager" width={1200} height={630} />
          </div>
        )
      }
    </header>

    <!-- Project Content -->
    {
      project.body && (
        <div class="typography mb-8 max-w-none">
          <Content />
        </div>
      )
    }

    <!-- Project Details -->
    <InfoBox variant="muted" class="mb-12" id="project-details">
      <div class="mb-4 flex items-end justify-between gap-4">
        <h2 class="text-foreground text-lg font-semibold">Project Details</h2>
        <span class="text-foreground-muted text-sm">Quick facts</span>
      </div>

      <dl class="grid gap-4 md:grid-cols-2">
        {
          project.data.completedOn && (
            <div class="bg-surface border-border rounded-lg border p-4">
              <dt class="text-foreground-muted mb-1 text-xs font-semibold tracking-wide uppercase">Completion Date</dt>
              <dd class="text-foreground text-base font-medium">
                {project.data.completedOn.toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                })}
              </dd>
            </div>
          )
        }

        {project.data.liveUrl && (
          <div class="bg-surface border-border rounded-lg border p-4">
            <dt class="text-foreground-muted mb-1 text-xs font-semibold tracking-wide uppercase">Project URL</dt>
            <dd class="text-base">
              <a
                href={project.data.liveUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="text-secondary hover:text-secondary-hover decoration-secondary/30 hover:decoration-secondary font-medium break-all underline underline-offset-2 transition-colors"
              >
                {project.data.liveUrl}
              </a>
            </dd>
          </div>
        )}

        {project.data.repoUrl && (
          <div class="bg-surface border-border rounded-lg border p-4 md:col-span-2">
            <dt class="text-foreground-muted mb-1 text-xs font-semibold tracking-wide uppercase">Repository</dt>
            <dd class="text-base">
              <a
                href={project.data.repoUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="text-secondary hover:text-secondary-hover decoration-secondary/30 hover:decoration-secondary font-medium break-all underline underline-offset-2 transition-colors"
              >
                {project.data.repoUrl}
              </a>
            </dd>
          </div>
        )}

        {project.data.technologies.length > 0 && (
          <div class="bg-surface border-border rounded-lg border p-4 md:col-span-2">
            <dt class="text-foreground-muted mb-3 text-xs font-semibold tracking-wide uppercase">Technologies</dt>
            <dd>
              <TagList tags={project.data.technologies} techMap={techMap} size="sm" />
            </dd>
          </div>
        )}
      </dl>
    </InfoBox>

    <!-- Project Footer -->
    <footer class="border-border mt-16 border-t pt-8">
      <div class="flex items-center justify-between">
        <a href="/projects" class="text-secondary hover:text-secondary-hover group flex items-center gap-1 font-medium">
          <FaArrowLeft className="icon-sm transition-transform group-hover:-translate-x-1" />
          View All Projects
        </a>
      </div>
    </footer>
  </article>
</MainLayout>
