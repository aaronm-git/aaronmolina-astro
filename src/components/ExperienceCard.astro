---
import { Image } from 'astro:assets';
import { FaBriefcase, FaExternalLinkAlt, FaCheck, FaChevronRight, FaAward } from 'react-icons/fa';

interface Props {
  experience: {
    data: {
      title: string;
      role: string;
      slug?: string;
      location: string;
      date: Date;
      endDate?: Date;
      isActive?: boolean;
      current?: boolean;
      responsibilities: string[];
      tags: string[];
      achievements: string[];
      logo?: string;
      description?: string;
      url?: string;
    };
  };
  showAllDetails?: boolean;
}

const { experience, showAllDetails = false } = Astro.props;

// Calculate duration
function calculateDuration(startDate: Date, endDate?: Date): string {
  const end = endDate ? endDate : new Date();
  const start = startDate;

  let years = end.getFullYear() - start.getFullYear();
  let months = end.getMonth() - start.getMonth();

  if (months < 0) {
    years--;
    months += 12;
  }

  const parts = [];
  if (years > 0) {
    parts.push(`${years} ${years === 1 ? 'year' : 'years'}`);
  }
  if (months > 0) {
    parts.push(`${months} ${months === 1 ? 'month' : 'months'}`);
  }

  return parts.length > 0 ? parts.join(', ') : '1 month';
}

const duration = calculateDuration(experience.data.date, experience.data.endDate);
---

<article
  class="animate-card border-primary-100 dark:border-primary-800 dark:bg-primary-900 rounded-lg border bg-white p-6 shadow-md transition-shadow hover:shadow-lg"
  id={experience.data.slug}
>
  <div class="mb-4 flex flex-col md:flex-row md:items-start md:justify-between">
    <div class="flex flex-col items-start gap-4 md:flex-row">
      <div
        class="bg-primary-50 dark:bg-primary-800 border-primary-200 dark:border-primary-600 flex aspect-square w-20 items-center justify-center overflow-hidden rounded border"
      >
        {
          experience.data.logo ? (
            <Image src={experience.data.logo} alt="Company logo" class="h-full w-full object-contain" loading="lazy" width={64} height={64} />
          ) : (
            <span class="text-primary-400 dark:text-primary-500 text-center text-xs">
              <FaBriefcase className="h-6 w-6" />
            </span>
          )
        }
      </div>
      <div class="space-y-1">
        <h3 class="text-primary-900 dark:text-primary-100 text-xl font-semibold">{experience.data.role}</h3>
        <h4 class="text-secondary-600 dark:text-secondary-400 text-lg font-medium">
          {experience.data.title}
          {
            experience.data.url && (
              <a
                href={experience.data.url}
                target="_blank"
                rel="noopener noreferrer"
                class="text-secondary-600 dark:text-secondary-400 hover:text-secondary-700 dark:hover:text-secondary-500 transition-colors"
              >
                <>
                  <FaExternalLinkAlt className="inline h-4 w-4" />
                  <span class="sr-only">Visit Site</span>
                </>
              </a>
            )
          }
        </h4>
        <p class="text-primary-600 dark:text-primary-400 text-sm">{experience.data.location}</p>
      </div>
    </div>
    <div class="md:text-right">
      <p class="text-primary-700 dark:text-primary-300 font-medium">
        {experience.data.date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
        {experience.data.endDate && !experience.data.current ? ` - ${experience.data.endDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}` : ''}
        {experience.data.current ? ' - Present' : ''}
      </p>
      <p class="text-primary-600 dark:text-primary-400 mt-1 text-sm">
        {duration}
      </p>
      {
        experience.data.current && (
          <span class="mt-1 inline-block rounded-full bg-green-100 px-2 py-1 text-xs text-green-800 dark:bg-green-800 dark:text-green-100">Current</span>
        )
      }
    </div>
  </div>

  {
    showAllDetails && experience.data.description && (
      <div class="border-primary-200 dark:border-primary-700 mb-8 max-w-2xl rounded-md border p-4">
        <p class="text-primary-700 dark:text-primary-300 text-sm">{experience.data.description}</p>
      </div>
    )
  }

  <div class="grid gap-6 md:grid-cols-2">
    <div>
      <h5 class="text-primary-900 dark:text-primary-100 mb-3 font-medium">Key Responsibilities</h5>
      <ul class="space-y-2">
        {
          experience.data.responsibilities.slice(0, showAllDetails ? undefined : 3).map(responsibility => (
            <li class="text-primary-700 dark:text-primary-300 flex items-start gap-2 text-sm">
              <FaCheck className="text-secondary-600 dark:text-secondary-400 mt-0.5 h-4 w-4 flex-shrink-0" />
              {responsibility}
            </li>
          ))
        }
      </ul>

      {
        !showAllDetails && (
          <div class="mt-4">
            <a
              href={`/experience#${experience.data.slug}`}
              class="text-secondary-600 dark:text-secondary-400 hover:text-secondary-700 dark:hover:text-secondary-500 group flex items-center gap-2 text-sm font-medium transition-colors"
            >
              See more details <FaChevronRight className="h-4 w-4 transition-transform group-hover:translate-x-1" />
            </a>
          </div>
        )
      }
    </div>

    <div>
      <h5 class="text-primary-900 dark:text-primary-100 mb-3 font-medium">Technologies & Tools</h5>
      <div class="flex flex-wrap gap-2">
        {
          experience.data.tags.slice(0, showAllDetails ? undefined : 8).map(tagSlug => {
            return (
              <span class="bg-secondary-50 dark:bg-secondary-900 text-secondary-700 dark:text-secondary-300 border-secondary-200 dark:border-secondary-700 rounded border px-2 py-1 text-xs font-medium">
                {tagSlug}
              </span>
            );
          })
        }
      </div>

      {
        experience.data.achievements.length > 0 && (
          <div class="mt-4">
            <h5 class="text-primary-900 dark:text-primary-100 mb-2 font-medium">Key Achievements</h5>
            <ul class="space-y-1">
              {experience.data.achievements.map((achievement: string) => (
                <li class="text-primary-700 dark:text-primary-300 flex items-start gap-2 text-sm">
                  <FaAward className="text-secondary-600 dark:text-secondary-400 mt-0.5 h-4 w-4 flex-shrink-0" />
                  {achievement}
                </li>
              ))}
            </ul>
          </div>
        )
      }
    </div>
  </div>
</article>
