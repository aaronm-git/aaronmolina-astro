---
import MainLayout from '@/layouts/main-layout.astro';
import ExperienceCard from '@/components/ExperienceCard.astro';
import { getCollection } from 'astro:content';
import tags from 'content/tags';
import CTA from '@/components/CTA.astro';

const experience = await getCollection('experience');
const sortedExperience = experience.sort((a, b) => {
  if (a.data.current && !b.data.current) return -1;
  if (!a.data.current && b.data.current) return 1;
  return b.data.date.getTime() - a.data.date.getTime();
});

// Create tag map for skills overview
const tagMap = new Map(tags.map(tag => [tag.slug, tag]));

// Extract unique tags from all experience and get their tag data
const allTags = experience.flatMap(exp => exp.data.tags);
const uniqueTags = [...new Set(allTags)];

// Group tags by category
const tagsByCategory = uniqueTags.reduce(
  (acc, tagSlug) => {
    const tag = tagMap.get(tagSlug);
    if (tag) {
      const category = tag.category || 'uncategorized';
      if (!acc[category]) {
        acc[category] = [];
      }
      acc[category].push(tag);
    }
    return acc;
  },
  {} as Record<string, any[]>
);

// Define category display info
const categoryInfo = {
  frontend: { title: 'Frontend Development', icon: 'monitor' },
  backend: { title: 'Backend & APIs', icon: 'server' },
  tools: { title: 'Tools & Platforms', icon: 'tool' },
  design: { title: 'Design & UX', icon: 'pen-tool' },
  devops: { title: 'DevOps & Cloud', icon: 'cloud' },
  cms: { title: 'Content Management', icon: 'edit' },
  other: { title: 'Other', icon: 'more-horizontal' },
};

// Calculate total years of experience
// const currentDate = new Date();
// const earliestDate = experience.reduce((earliest, exp) => {
//   return exp.data.date < earliest ? exp.data.date : earliest;
// }, currentDate);
// const yearsOfExperience = Math.floor((currentDate.getTime() - earliestDate.getTime()) / (1000 * 60 * 60 * 24 * 365));
const yearsOfExperience = 10;
---

<MainLayout>
  <!-- Header Section -->
  <header class="animate-section mb-12 text-center">
    <h1 class="text-primary-900 dark:text-primary-100 mb-4 text-5xl font-bold">Professional Experience</h1>
    <p class="text-primary-700 dark:text-primary-300 mb-6 text-xl">
      {yearsOfExperience}+ years of building exceptional web experiences
    </p>
    <p class="text-primary-600 dark:text-primary-400 mx-auto max-w-3xl text-lg leading-relaxed">
      My journey as a developer has taken me through various technologies, teams, and challenges. Here's a comprehensive overview of my professional experience, skills, and
      achievements.
    </p>
  </header>

  <!-- Experience Timeline -->
  <section class="animate-section mb-16">
    <h2 class="text-primary-900 dark:text-primary-100 mb-8 flex items-center gap-3 text-2xl font-bold md:text-3xl">
      <span data-feather="briefcase" class="text-secondary-600 dark:text-secondary-400"></span>
      Work Experience
    </h2>

    <div class="animate-content space-y-8">
      {sortedExperience.map(exp => <ExperienceCard experience={exp} showAllDetails={true} />)}
    </div>
  </section>

  <!-- Skills Overview -->
  <section class="animate-section mb-16">
    <h2 class="text-primary-900 dark:text-primary-100 mb-8 flex items-center gap-3 text-2xl font-bold md:text-3xl">
      <span data-feather="code" class="text-secondary-600 dark:text-secondary-400"></span>
      Technical Skills & Expertise
    </h2>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {
        Object.entries(categoryInfo)
          .filter(([categorySlug]) => tagsByCategory[categorySlug]?.length > 0)
          .map(([categorySlug, info]) => (
            <div class="animate-content border-primary-100 dark:border-primary-800 rounded-lg border bg-white dark:bg-primary-900 p-6 shadow-md">
              <h3 class="text-primary-900 dark:text-primary-100 mb-4 flex items-center gap-2 text-lg font-semibold">
                <span data-feather={info.icon} class="text-secondary-600 dark:text-secondary-400" />
                {info.title}
              </h3>
              <div class="flex flex-wrap gap-2">
                {tagsByCategory[categorySlug]?.map(tag => (
                  <span class="bg-secondary-50 dark:bg-secondary-900 text-secondary-700 dark:text-secondary-300 border-secondary-200 dark:border-secondary-700 rounded-full border px-3 py-1 text-sm font-medium">{tag.title}</span>
                ))}
              </div>
            </div>
          ))
      }
    </div>
  </section>

  <!-- Career Highlights -->
  <section class="animate-section mb-16">
    <h2 class="text-primary-900 dark:text-primary-100 mb-8 flex items-center gap-3 text-2xl font-bold md:text-3xl">
      <span data-feather="award" class="text-secondary-600 dark:text-secondary-400"></span>
      Career Highlights
    </h2>

    <div class="grid gap-8 md:grid-cols-2">
      <div class="animate-content border-primary-100 dark:border-primary-800 rounded-lg border bg-white dark:bg-primary-900 p-6 shadow-md">
        <h3 class="text-primary-900 dark:text-primary-100 mb-4 flex items-center gap-2 text-lg font-semibold">
          <span data-feather="trending-up" class="text-secondary-600 dark:text-secondary-400"></span>
          Key Achievements
        </h3>
        <ul class="space-y-3">
          {
            experience
              .flatMap(exp => exp.data.achievements)
              .slice(0, 6)
              .map(achievement => (
                <li class="text-primary-700 dark:text-primary-300 flex items-start gap-2 text-sm">
                  <span data-feather="check-circle" class="text-secondary-600 dark:text-secondary-400 mt-0.5 h-4 w-4 flex-shrink-0" />
                  {achievement}
                </li>
              ))
          }
        </ul>
      </div>

      <div class="animate-content border-primary-100 dark:border-primary-800 rounded-lg border bg-white dark:bg-primary-900 p-6 shadow-md">
        <h3 class="text-primary-900 dark:text-primary-100 mb-4 flex items-start gap-2 text-lg font-semibold">
          <span data-feather="target" class="text-secondary-600 dark:text-secondary-400"></span>
          Core Competencies
        </h3>
        <ul class="space-y-3">
          <li class="text-primary-700 dark:text-primary-300 flex items-start gap-2 text-sm">
            <span data-feather="code" class="text-secondary-600 dark:text-secondary-400 mt-0.5 h-4 w-4 flex-shrink-0"></span>
            Full-stack web development with modern frameworks
          </li>
          <li class="text-primary-700 dark:text-primary-300 flex items-start gap-2 text-sm">
            <span data-feather="smartphone" class="text-secondary-600 dark:text-secondary-400 mt-0.5 h-4 w-4 flex-shrink-0"></span>
            Responsive design and mobile-first development
          </li>
          <li class="text-primary-700 dark:text-primary-300 flex items-start gap-2 text-sm">
            <span data-feather="zap" class="text-secondary-600 dark:text-secondary-400 mt-0.5 h-4 w-4 flex-shrink-0"></span>
            Performance optimization and Core Web Vitals
          </li>
          <li class="text-primary-700 dark:text-primary-300 flex items-start gap-2 text-sm">
            <span data-feather="users" class="text-secondary-600 dark:text-secondary-400 mt-0.5 h-4 w-4 flex-shrink-0"></span>
            Cross-functional team collaboration and leadership
          </li>
          <li class="text-primary-700 dark:text-primary-300 flex items-start gap-2 text-sm">
            <span data-feather="eye" class="text-secondary-600 dark:text-secondary-400 mt-0.5 h-4 w-4 flex-shrink-0"></span>
            Accessibility standards and inclusive design
          </li>
          <li class="text-primary-700 dark:text-primary-300 flex items-start gap-2 text-sm">
            <span data-feather="cloud" class="text-secondary-600 dark:text-secondary-400 mt-0.5 h-4 w-4 flex-shrink-0"></span>
            Cloud platforms and DevOps practices
          </li>
        </ul>
      </div>
    </div>
  </section>

  <div class="animate-section">
    <CTA />
  </div>
</MainLayout>
