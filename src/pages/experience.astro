---
import MainLayout from '@/layouts/main-layout.astro';
import RoleCard from '@/components/organisms/cards/RoleCard.astro';
import CTASection from '@/components/organisms/sections/CTASection.astro';
import SectionHeader from '@/components/molecules/SectionHeader.astro';
import InfoBox from '@/components/molecules/InfoBox.astro';
import ListItem from '@/components/molecules/ListItem.astro';
import { getCollection } from 'astro:content';
import homepageContent from '@/content/site/homepage.json';
import pages from '@/content/site/pages.json';

const roles = await getCollection('roles');
const organizations = await getCollection('organizations');
const orgBySlug = new Map(organizations.map((o) => [o.data.slug, o]));
const now = Date.now();

const sortedRoles = roles
  .filter((r) => r.data.isActive !== false)
  .sort((a, b) => {
    const aCurrent = Boolean(a.data.current);
    const bCurrent = Boolean(b.data.current);

    if (aCurrent && bCurrent) {
      const aDuration = (a.data.endDate?.getTime() ?? now) - a.data.startDate.getTime();
      const bDuration = (b.data.endDate?.getTime() ?? now) - b.data.startDate.getTime();
      if (aDuration !== bDuration) return aDuration - bDuration;
    } else {
      if (aCurrent && !bCurrent) return -1;
      if (!aCurrent && bCurrent) return 1;
    }

    if ((a.data.sortOrder ?? 0) !== (b.data.sortOrder ?? 0)) return (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0);
    return b.data.startDate.getTime() - a.data.startDate.getTime();
  });

const yearsOfExperience = new Date().getFullYear() - homepageContent.yearsOfExperienceStartYear;
const experienceSubheading = pages.experience.subheadingTemplate.replaceAll('{yearsOfExperience}', String(yearsOfExperience));
const competencyIconNames = ['code', 'rocket', 'bolt', 'users', 'lightbulb', 'globe'];
---

<MainLayout title={pages.experience.metaTitle} description={pages.experience.metaDescription}>
  <!-- Header Section -->
  <section class="animate-section mb-12 text-center">
    <h1 class="text-foreground mb-4 text-5xl font-bold">{pages.experience.heading}</h1>
    <p class="text-foreground-muted mb-6 text-xl">
      {experienceSubheading}
    </p>
    <p class="text-foreground-muted mx-auto max-w-3xl text-lg leading-relaxed">
      {pages.experience.intro}
    </p>
  </section>

  <!-- Experience Timeline -->
  <section class="animate-section mb-16">
    <SectionHeader title={pages.experience.workExperienceTitle} icon="briefcase" />

    <div class="animate-content space-y-8">
      {sortedRoles.map((role) => <RoleCard role={role} organization={orgBySlug.get(role.data.organization)} showAllDetails={true} />)}
    </div>
  </section>

  <!-- Career Highlights -->
  <section class="animate-section mb-16">
    <SectionHeader title={pages.experience.careerHighlightsTitle} icon="award" />

    <div class="grid gap-8 md:grid-cols-2">
      <InfoBox title={pages.experience.keyAchievementsTitle} icon="star" variant="surface">
        <ul class="space-y-3">
          {
            roles
              .flatMap(r => r.data.achievements)
              .slice(0, 6)
              .map(achievement => (
                <ListItem icon="check" iconColor="secondary">
                  {achievement}
                </ListItem>
              ))
          }
        </ul>
      </InfoBox>

      <InfoBox title={pages.experience.coreCompetenciesTitle} icon="lightbulb" variant="surface">
        <ul class="space-y-3">
          {pages.experience.coreCompetencies.map((item, idx) => {
            const iconName = competencyIconNames[idx] || 'code';
            return (
              <ListItem icon={iconName} iconColor="secondary">
                {item.title}
              </ListItem>
            );
          })}
        </ul>
      </InfoBox>
    </div>
  </section>

  <div class="animate-section">
    <CTASection />
  </div>
</MainLayout>
