---
import MainLayout from '@/layouts/main-layout.astro';
import HeroSection from '@/components/organisms/sections/HeroSection.astro';
import ProjectsSection from '@/components/organisms/sections/ProjectsSection.astro';
import CTASection from '@/components/organisms/sections/CTASection.astro';
import { getCollection } from 'astro:content';
import pages from '@/content/site/pages.json';

const projects = await getCollection('projects');

// Sort projects by featured/sortOrder, then completion date (newest first)
const sortedProjects = projects
  .filter(project => project.data.isActive)
  .sort((a, b) => {
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    if ((a.data.sortOrder ?? 0) !== (b.data.sortOrder ?? 0)) return (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0);
    const aDate = a.data.completedOn ? new Date(a.data.completedOn).getTime() : 0;
    const bDate = b.data.completedOn ? new Date(b.data.completedOn).getTime() : 0;
    return bDate - aDate;
  });
---

<MainLayout title={pages.projectsIndex.metaTitle} description={pages.projectsIndex.metaDescription}>
  <HeroSection
    variant="minimal"
    headline={pages.projectsIndex.heading}
    description={pages.projectsIndex.intro}
    class="py-8"
  />

  {sortedProjects.length > 0 ? (
    <ProjectsSection
      title=""
      projects={sortedProjects}
      variant="grid"
      columns={3}
      showCompletedDate
      showViewProjectLink
      class="animate-section py-0"
    />
  ) : (
    <div class="py-12 text-center">
      <p class="text-foreground-muted">{pages.projectsIndex.emptyState}</p>
    </div>
  )}

  <CTASection class="animate-section mt-12" />
</MainLayout>
