---
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';
import { FaBriefcase, FaArrowRight, FaCheck, FaAward } from '@/utils/icons';
import { getCollection } from 'astro:content';
import { createTechMap } from '@/utils/tech-lookup';
import { formatDateRange, calculateDuration } from '@/utils/date-format';
import TagList from '@/components/ui/TagList.astro';
import ListItem from '@/components/ui/ListItem.astro';

interface Props {
  role: {
    data: {
      title: string;
      slug: string;
      organization: string;
      location?: string;
      startDate: Date;
      endDate?: Date;
      current?: boolean;
      summary?: string;
      highlights: string[];
      achievements: string[];
      technologies: string[];
      isActive?: boolean;
    };
  };
  organization?: {
    data: {
      name: string;
      slug: string;
      logo?: ImageMetadata;
      website?: string;
      location?: string;
    };
  };
  showAllDetails?: boolean;
}

const { role, organization, showAllDetails = false } = Astro.props;

const technologies = await getCollection('technologies');
const techMap = createTechMap(technologies);

const duration = calculateDuration(role.data.startDate, role.data.endDate);
const dateRange = formatDateRange(role.data.startDate, role.data.endDate, role.data.current);
const orgName = organization?.data.name || role.data.organization;
const logoAlt = `${orgName.trim()} logo`;
---

<article class="tactile-card p-6" id={role.data.slug}>
  <div class="mb-4 flex flex-col md:flex-row md:items-start md:justify-between">
    <div class="flex flex-col items-start gap-4 md:flex-row">
      <div class="bg-muted border-border flex aspect-square w-20 items-center justify-center overflow-hidden rounded border">
        {
          organization?.data.logo ? (
            <Image src={organization.data.logo} alt={logoAlt} loading="lazy" width={100} height={100} />
          ) : (
            <span class="text-foreground-muted text-center text-xs">
              <FaBriefcase className="icon-lg" />
            </span>
          )
        }
      </div>
      <div class="space-y-1">
        <h3 class="text-foreground text-xl font-semibold">{role.data.title}</h3>
        <h4 class="text-secondary text-lg font-medium">
          {orgName}
          {
            organization?.data.website && (
              <a href={organization.data.website} target="_blank" rel="noopener noreferrer" class="text-secondary hover:text-secondary-hover transition-colors">
                <>
                  <FaArrowRight className="inline icon-sm" />
                  <span class="sr-only">Visit Site</span>
                </>
              </a>
            )
          }
        </h4>
        {role.data.location && <p class="text-foreground-muted text-sm">{role.data.location}</p>}
      </div>
    </div>
    <div class="md:text-right">
      <p class="text-foreground-muted font-medium">{dateRange}</p>
      <p class="text-foreground-muted mt-1 text-sm">{duration}</p>
      {role.data.current && <span class="bg-secondary text-on-secondary mt-1 inline-block rounded-full px-2 py-1 text-xs">Current</span>}
    </div>
  </div>

  {showAllDetails && role.data.summary && (
    <div class="border-border mb-8 max-w-2xl rounded-md border p-4">
      <p class="text-foreground-muted text-sm">{role.data.summary}</p>
    </div>
  )}

  <div class="grid gap-6 md:grid-cols-2">
    <div>
      <h5 class="text-foreground mb-3 font-medium">Highlights</h5>
      <ul class="space-y-2">
        {role.data.highlights.slice(0, showAllDetails ? undefined : 3).map((highlight) => (
          <ListItem icon="check" iconColor="secondary">
            {highlight}
          </ListItem>
        ))}
      </ul>

      {!showAllDetails && (
        <div class="mt-4">
          <a href={`/experience#${role.data.slug}`} class="text-secondary hover:text-secondary-hover group flex items-center gap-1 text-sm font-medium transition-colors">
            See more details <FaArrowRight className="icon-sm transition-transform group-hover:translate-x-1" />
          </a>
        </div>
      )}
    </div>

    <div>
      <h5 class="text-foreground mb-3 font-medium">Technologies</h5>
      <TagList
        tags={role.data.technologies}
        techMap={techMap}
        limit={showAllDetails ? undefined : 10}
      />

      {role.data.achievements.length > 0 && (
        <div class="mt-4">
          <h5 class="text-foreground mb-2 font-medium">Key Achievements</h5>
          <ul class="space-y-1">
            {role.data.achievements.map((achievement) => (
              <ListItem icon="award" iconColor="secondary" compact>
                {achievement}
              </ListItem>
            ))}
          </ul>
        </div>
      )}
    </div>
  </div>
</article>
