---
import MainLayout from '@/layouts/main-layout.astro';
import ProjectCard from '@/components/ProjectCard.astro';
import ExperienceCard from '@/components/ExperienceCard.astro';
import CTA from '@/components/CTA.astro';
import { getCollection } from 'astro:content';
import tags from 'content/tags';

const posts = await getCollection('blog');
const recentPosts = posts.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()).slice(0, 3);

const experience = await getCollection('experience');
const sortedExperience = experience
  .sort((a, b) => {
    if (a.data.current && !b.data.current) return -1;
    if (!a.data.current && b.data.current) return 1;
    return b.data.date.getTime() - a.data.date.getTime();
  })
  .slice(0, 4);

const projects = await getCollection('projects');
const featuredProjects = projects
  .filter(project => project.data.pinned || project.data.isActive)
  .sort((a, b) => {
    if (a.data.pinned && !b.data.pinned) return -1;
    if (!a.data.pinned && b.data.pinned) return 1;
    return (b.data.completedOn?.getTime() || 0) - (a.data.completedOn?.getTime() || 0);
  })
  .slice(0, 3);

// Create tag map
const tagMap = new Map(tags.map(tag => [tag.slug, tag]));

// Extract unique tags from experience and get their tag data
const allTags = experience.flatMap(exp => exp.data.tags);
const uniqueTags = [...new Set(allTags)];

// Group tags by category
const tagsByCategory = uniqueTags.reduce(
  (acc, tagSlug) => {
    const tag = tagMap.get(tagSlug);
    if (tag) {
      const category = tag.category || 'uncategorized';
      if (!acc[category]) {
        acc[category] = [];
      }
      acc[category].push(tag);
    }
    return acc;
  },
  {} as Record<string, any[]>,
);

// Define category display info
const categoryInfo = {
  frontend: { title: 'Frontend Development', icon: 'monitor' },
  backend: { title: 'Backend & APIs', icon: 'server' },
  tools: { title: 'Tools & Platforms', icon: 'tool' },
  design: { title: 'Design & UX', icon: 'pen-tool' },
  devops: { title: 'DevOps & Cloud', icon: 'cloud' },
  cms: { title: 'Content Management', icon: 'edit' },
  other: { title: 'Other', icon: 'more-horizontal' },
};
---

<MainLayout>
  <div class="mx-auto max-w-6xl p-8">
    <!-- Hero Section -->
    <header class="mb-16 text-center">
      <h1 class="text-primary-900 mb-6 text-6xl font-bold">Aaron Molina</h1>
      <p class="text-primary-700 mb-4 text-2xl">Senior Frontend & Fullstack Developer</p>
      <p class="text-primary-600 mx-auto max-w-3xl text-lg leading-relaxed">
        Passionate about building modern, accessible web applications with cutting-edge technologies. Specializing in React, Vue.js, TypeScript, and performance optimization with a
        focus on user experience and code quality.
      </p>
      <div class="mt-8 flex justify-center gap-4">
        <a href="/projects" class="bg-secondary-600 hover:bg-secondary-700 inline-flex items-center gap-2 rounded-lg px-8 py-3 font-medium text-white transition-colors">
          <span data-feather="briefcase"></span>
          View My Work
        </a>
        <a href="/blog" class="bg-primary-600 hover:bg-primary-700 inline-flex items-center gap-2 rounded-lg px-8 py-3 font-medium text-white transition-colors">
          <span data-feather="book-open"></span>
          Read My Blog
        </a>
      </div>
    </header>

    <!-- Featured Projects Section -->
    <section class="mb-16">
      <div class="mb-8 flex items-center justify-between">
        <h2 class="text-primary-900 flex items-center gap-3 text-3xl font-bold">
          <span data-feather="star" class="text-secondary-600"></span>
          Featured Projects
        </h2>
        <a href="/projects" class="text-secondary-600 hover:text-secondary-800 flex items-center gap-2 font-medium">
          View all projects <span data-feather="arrow-right"></span>
        </a>
      </div>

      <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
        {featuredProjects.map(project => <ProjectCard project={project} showCompletedDate={false} />)}
      </div>
    </section>

    <!-- Experience Section -->
    <section class="mb-16">
      <div class="mb-8 flex items-center justify-between">
        <h2 class="text-primary-900 flex items-center gap-3 text-3xl font-bold">
          <span data-feather="briefcase" class="text-secondary-600"></span>
          Professional Experience
        </h2>
        <a href="/experience" class="text-secondary-600 hover:text-secondary-800 flex items-center gap-2 font-medium">
          View all experience <span data-feather="arrow-right"></span>
        </a>
      </div>

      <div class="space-y-8">
        {sortedExperience.map(exp => <ExperienceCard experience={exp} showAllDetails={false} />)}
      </div>
    </section>

    <!-- Skills Section -->
    <section class="mb-16">
      <h2 class="text-primary-900 mb-8 flex items-center gap-3 text-3xl font-bold">
        <span data-feather="code" class="text-secondary-600"></span>
        Technical Skills
      </h2>

      <div class="grid gap-8 md:grid-cols-3">
        {
          Object.entries(categoryInfo)
                    .filter(([categorySlug]) => tagsByCategory[categorySlug]?.length > 0)
        .map(([categorySlug, info]) => (
          <div class="border-primary-100 rounded-lg border bg-white p-6 shadow-md">
            <h3 class="text-primary-900 mb-4 flex items-center gap-2 text-lg font-semibold">
              <span data-feather={info.icon} class="text-secondary-600" />
              {info.title}
            </h3>
            <div class="flex flex-wrap gap-2">
              {tagsByCategory[categorySlug]?.map(tag => (
                    <span class="bg-secondary-50 text-secondary-700 border-secondary-200 rounded-full border px-3 py-1 text-sm font-medium">{tag.title}</span>
                  ))}
                </div>
              </div>
            ))
        }
      </div>
    </section>

    <!-- Recent Blog Posts -->
    {
      recentPosts.length > 0 && (
        <section class="mb-16">
          <div class="mb-8 flex items-center justify-between">
            <h2 class="text-primary-900 flex items-center gap-3 text-3xl font-bold">
              <span data-feather="edit-3" class="text-secondary-600" />
              Latest Articles
            </h2>
            <a href="/blog" class="text-secondary-600 hover:text-secondary-800 flex items-center gap-2 font-medium">
              View all posts <span data-feather="arrow-right" />
            </a>
          </div>

          <div class="grid gap-6 md:grid-cols-3">
            {recentPosts.map(post => (
              <article class="border-primary-100 rounded-lg border bg-white p-6 shadow-md transition-shadow hover:shadow-lg">
                <h3 class="text-primary-900 mb-3 text-lg font-semibold">
                  <a href={`/blog/${post.data.slug}`} class="hover:text-secondary-600 transition-colors">
                    {post.data.title}
                  </a>
                </h3>
                <div class="text-primary-600 mb-3 flex items-center text-sm">
                  <span data-feather="calendar" class="mr-2 h-4 w-4" />
                  <time datetime={post.data.date.toISOString()}>
                    {post.data.date.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                    })}
                  </time>
                </div>
                {post.data.description && <p class="text-primary-700 mb-4 text-sm leading-relaxed">{post.data.description}</p>}
                <a href={`/blog/${post.data.slug}`} class="text-secondary-600 hover:text-secondary-800 flex items-center gap-1 font-medium">
                  Read more <span data-feather="arrow-right" class="h-4 w-4" />
                </a>
              </article>
            ))}
          </div>
        </section>
      )
    }

    <!-- Contact Section -->
    <CTA />
  </div>
</MainLayout>
