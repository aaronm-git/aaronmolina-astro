---
import MainLayout from "@/layouts/main-layout.astro";
import ExperienceCard from "@/components/ExperienceCard.astro";
import { getCollection } from "astro:content";

const experience = await getCollection("experience");
const sortedExperience = experience
  .sort((a, b) => {
    if (a.data.current && !b.data.current) return -1;
    if (!a.data.current && b.data.current) return 1;
    return b.data.date.getTime() - a.data.date.getTime();
  });

// Get all tags and group by category for skills overview
const tags = await getCollection("tags");
const tagMap = new Map(tags.map(tag => [tag.data.slug, tag.data]));

// Extract unique skills from all experience and get their tag data
const allSkills = experience.flatMap(exp => exp.data.skills);
const uniqueSkills = [...new Set(allSkills)];

// Group skills by category
const skillsByCategory = uniqueSkills.reduce((acc, skillSlug) => {
  const tag = tagMap.get(skillSlug);
  if (tag) {
    const category = tag.category;
    if (!acc[category]) {
      acc[category] = [];
    }
    acc[category].push(tag);
  }
  return acc;
}, {} as Record<string, any[]>);

// Define category display info
const categoryInfo = {
  frontend: { title: "Frontend Development", icon: "monitor" },
  backend: { title: "Backend & APIs", icon: "server" },
  tools: { title: "Tools & Platforms", icon: "tool" },
  design: { title: "Design & UX", icon: "pen-tool" },
  devops: { title: "DevOps & Cloud", icon: "cloud" },
  cms: { title: "Content Management", icon: "edit" },
  other: { title: "Other", icon: "more-horizontal" }
};

// Calculate total years of experience
const currentDate = new Date();
const earliestDate = experience.reduce((earliest, exp) => {
  return exp.data.date < earliest ? exp.data.date : earliest;
}, currentDate);
const yearsOfExperience = Math.floor((currentDate.getTime() - earliestDate.getTime()) / (1000 * 60 * 60 * 24 * 365));
---

<MainLayout>
  <div class="max-w-6xl mx-auto p-8">
    <!-- Header Section -->
    <header class="mb-12 text-center">
      <h1 class="text-5xl font-bold mb-4 text-primary-900">Professional Experience</h1>
      <p class="text-xl text-primary-700 mb-6">
        {yearsOfExperience}+ years of building exceptional web experiences
      </p>
      <p class="text-lg text-primary-600 max-w-3xl mx-auto leading-relaxed">
        My journey as a developer has taken me through various technologies, teams, and challenges. 
        Here's a comprehensive overview of my professional experience, skills, and achievements.
      </p>
    </header>

    <!-- Experience Timeline -->
    <section class="mb-16">
      <h2 class="text-3xl font-bold text-primary-900 mb-8 flex items-center gap-3">
        <span data-feather="briefcase" class="text-secondary-600"></span>
        Work Experience
      </h2>
      
      <div class="space-y-8">
        {sortedExperience.map((exp) => (
          <ExperienceCard experience={exp} showAllDetails={true} />
        ))}
      </div>
    </section>

    <!-- Skills Overview -->
    <section class="mb-16">
      <h2 class="text-3xl font-bold text-primary-900 mb-8 flex items-center gap-3">
        <span data-feather="code" class="text-secondary-600"></span>
        Technical Skills & Expertise
      </h2>
      
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {Object.entries(categoryInfo).filter(([categorySlug]) => skillsByCategory[categorySlug]?.length > 0).map(([categorySlug, info]) => (
          <div class="bg-white rounded-lg shadow-md border border-primary-100 p-6">
            <h3 class="text-lg font-semibold text-primary-900 mb-4 flex items-center gap-2">
              <span data-feather={info.icon} class="text-secondary-600"></span>
              {info.title}
            </h3>
            <div class="flex flex-wrap gap-2">
              {skillsByCategory[categorySlug]?.map((tag) => (
                <span class="px-3 py-1 bg-secondary-50 text-secondary-700 rounded-full text-sm font-medium border border-secondary-200">
                  {tag.title}
                </span>
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- Career Highlights -->
    <section class="mb-16">
      <h2 class="text-3xl font-bold text-primary-900 mb-8 flex items-center gap-3">
        <span data-feather="award" class="text-secondary-600"></span>
        Career Highlights
      </h2>
      
      <div class="grid md:grid-cols-2 gap-8">
        <div class="bg-white rounded-lg shadow-md border border-primary-100 p-6">
          <h3 class="text-lg font-semibold text-primary-900 mb-4 flex items-center gap-2">
            <span data-feather="trending-up" class="text-secondary-600"></span>
            Key Achievements
          </h3>
          <ul class="space-y-3">
            {experience.flatMap(exp => exp.data.achievements).slice(0, 6).map((achievement) => (
              <li class="text-primary-700 text-sm flex items-start gap-2">
                <span data-feather="check-circle" class="w-4 h-4 text-secondary-600 flex-shrink-0 mt-0.5"></span>
                {achievement}
              </li>
            ))}
          </ul>
        </div>
        
        <div class="bg-white rounded-lg shadow-md border border-primary-100 p-6">
          <h3 class="text-lg font-semibold text-primary-900 mb-4 flex items-center gap-2">
            <span data-feather="target" class="text-secondary-600"></span>
            Core Competencies
          </h3>
          <ul class="space-y-3">
            <li class="text-primary-700 text-sm flex items-start gap-2">
              <span data-feather="code" class="w-4 h-4 text-secondary-600 flex-shrink-0 mt-0.5"></span>
              Full-stack web development with modern frameworks
            </li>
            <li class="text-primary-700 text-sm flex items-start gap-2">
              <span data-feather="smartphone" class="w-4 h-4 text-secondary-600 flex-shrink-0 mt-0.5"></span>
              Responsive design and mobile-first development
            </li>
            <li class="text-primary-700 text-sm flex items-start gap-2">
              <span data-feather="zap" class="w-4 h-4 text-secondary-600 flex-shrink-0 mt-0.5"></span>
              Performance optimization and Core Web Vitals
            </li>
            <li class="text-primary-700 text-sm flex items-start gap-2">
              <span data-feather="users" class="w-4 h-4 text-secondary-600 flex-shrink-0 mt-0.5"></span>
              Cross-functional team collaboration and leadership
            </li>
            <li class="text-primary-700 text-sm flex items-start gap-2">
              <span data-feather="eye" class="w-4 h-4 text-secondary-600 flex-shrink-0 mt-0.5"></span>
              Accessibility standards and inclusive design
            </li>
            <li class="text-primary-700 text-sm flex items-start gap-2">
              <span data-feather="cloud" class="w-4 h-4 text-secondary-600 flex-shrink-0 mt-0.5"></span>
              Cloud platforms and DevOps practices
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Contact Section -->
    <section class="bg-primary-50 rounded-lg border border-primary-100 p-8 text-center">
      <h2 class="text-3xl font-bold text-primary-900 mb-4">Ready to Work Together?</h2>
      <p class="text-primary-700 mb-6 max-w-2xl mx-auto">
        I'm always interested in discussing new opportunities, challenging projects, or potential collaborations. 
        Let's connect and explore how we can create something amazing together.
      </p>
      <div class="flex justify-center gap-4">
        <a
          href="mailto:contact@aaronmolina.dev"
          class="inline-flex items-center gap-2 bg-secondary-600 text-white px-6 py-3 rounded-lg hover:bg-secondary-700 transition-colors font-medium"
        >
          <span data-feather="mail"></span>
          Get In Touch
        </a>
        <a
          href="/projects"
          class="inline-flex items-center gap-2 bg-primary-600 text-white px-6 py-3 rounded-lg hover:bg-primary-700 transition-colors font-medium"
        >
          <span data-feather="briefcase"></span>
          View My Work
        </a>
      </div>
    </section>
  </div>
</MainLayout>
