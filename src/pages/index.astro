---
import MainLayout from '@/layouts/main-layout.astro';
import ProjectCard from '@/components/organisms/cards/ProjectCard.astro';
import RoleCard from '@/components/organisms/cards/RoleCard.astro';
import CTASection from '@/components/organisms/sections/CTASection.astro';
import BlogPostCard from '@/components/organisms/cards/BlogPostCard.astro';
import SectionHeader from '@/components/molecules/SectionHeader.astro';
import Button from '@/components/atoms/Button.astro';
import { getCollection } from 'astro:content';
import { createTechMap } from '@/utils/tech-lookup';
import ProfilePicture from '@/images/profile.jpg';
import { Image } from 'astro:assets';
import homepageContent from '@/content/site/homepage.json';
import pages from '@/content/site/pages.json';
import navigation from '@/content/site/navigation.json';

const posts = await getCollection('blog');
const technologies = await getCollection('technologies');
const techMap = createTechMap(technologies);

const currentDate = new Date();
const recentPosts = posts
  .filter(post => post.data.publishDate !== null)
  .filter(post => post.data.publishDate! <= currentDate)
  .sort((a, b) => b.data.publishDate!.getTime() - a.data.publishDate!.getTime())
  .slice(0, 3);

const roles = await getCollection('roles');
const organizations = await getCollection('organizations');

const orgBySlug = new Map(organizations.map((o) => [o.data.slug, o]));
const now = Date.now();

const featuredRoles = roles
  .filter((r) => r.data.isActive !== false)
  .sort((a, b) => {
    const aCurrent = Boolean(a.data.current);
    const bCurrent = Boolean(b.data.current);

    if (aCurrent && bCurrent) {
      const aDuration = (a.data.endDate?.getTime() ?? now) - a.data.startDate.getTime();
      const bDuration = (b.data.endDate?.getTime() ?? now) - b.data.startDate.getTime();
      if (aDuration !== bDuration) return aDuration - bDuration;
    } else {
      if (aCurrent && !bCurrent) return -1;
      if (!aCurrent && bCurrent) return 1;
    }

    // featured first for non-current (or tie-breaking)
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    // then sortOrder
    if ((a.data.sortOrder ?? 0) !== (b.data.sortOrder ?? 0)) return (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0);
    // then by startDate (newest first)
    return b.data.startDate.getTime() - a.data.startDate.getTime();
  })
  .slice(0, 4);

const projects = await getCollection('projects');
const featuredProjects = projects
  .filter(project => project.data.isActive !== false)
  .sort((a, b) => {
    // featured first
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    if ((a.data.sortOrder ?? 0) !== (b.data.sortOrder ?? 0)) return (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0);
    return (b.data.completedOn?.getTime() || 0) - (a.data.completedOn?.getTime() || 0);
  })
  .slice(0, 3);

const yearsOfExperience = new Date().getFullYear() - homepageContent.yearsOfExperienceStartYear;
const heroDescription = homepageContent.hero.description.replaceAll('{yearsOfExperience}', String(yearsOfExperience));
---

<MainLayout>
  <!-- Hero Section -->
  <section class="relative my-16 text-center">
    <div class="hero-image mb-8 flex justify-center">
      <Image
        src={ProfilePicture}
        alt={navigation.brandAlt}
        class="tactile-profile-img h-32 w-32 rounded-2xl object-cover object-[20%_40%] md:h-48 md:w-48"
        loading="eager"
      />
    </div>
    <h1 class="hero-title text-foreground mb-1 text-4xl font-bold md:mb-6 md:text-6xl">{homepageContent.hero.name}</h1>
    <p class="hero-subtitle text-foreground-muted mb-4 text-lg font-medium md:text-2xl">{homepageContent.hero.headline}</p>
    <p class="hero-description text-foreground-muted mx-auto max-w-3xl text-base leading-relaxed md:text-lg">
      {heroDescription}
    </p>
    <div class="mt-8 flex flex-col items-center justify-center gap-4 max-md:gap-2 md:flex-row">
      <Button href="/projects" variant="secondary" icon="briefcase" size="lg" class="hero-cta">
        {pages.home.buttons.viewWorkLabel}
      </Button>
      <Button href="/blog" variant="primary" icon="blog" size="lg" class="hero-cta">
        {pages.home.buttons.readBlogLabel}
      </Button>
    </div>
  </section>

  <!-- Featured Projects Section -->
  <section class="animate-section mb-16">
    <SectionHeader
      title={pages.home.sections.featuredProjectsTitle}
      icon="star"
      viewAllHref="/projects"
      viewAllLabel={pages.home.sections.featuredProjectsViewAllLabel}
      hideViewAllOnMobile
    />

    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {featuredProjects.map(project => <ProjectCard project={project} showCompletedDate={false} showViewProjectLink={false} />)}
    </div>

    <a href="/projects" class="text-secondary hover:text-secondary-hover mt-6 flex items-center justify-end gap-2 font-medium md:hidden">
      {pages.home.sections.featuredProjectsViewAllLabel}
    </a>
  </section>

  <!-- Experience Section -->
  <section class="animate-section mb-16">
    <SectionHeader
      title={pages.home.sections.experienceTitle}
      icon="briefcase"
      viewAllHref="/experience"
      viewAllLabel={pages.home.sections.experienceViewAllLabel}
      hideViewAllOnMobile
    />

    <div class="animate-content space-y-8">
      {featuredRoles.map((role) => <RoleCard role={role} organization={orgBySlug.get(role.data.organization)} showAllDetails={false} />)}
    </div>

    <a href="/experience" class="text-secondary hover:text-secondary-hover mt-6 flex items-center justify-end gap-2 font-medium md:hidden">
      {pages.home.sections.experienceViewAllLabel}
    </a>
  </section>

  <!-- Recent Blog Posts -->
  {
    recentPosts.length > 0 && (
      <section class="animate-section mb-16">
        <SectionHeader
          title={pages.home.sections.latestArticlesTitle}
          icon="blog"
          viewAllHref="/blog"
          viewAllLabel={pages.home.sections.latestArticlesViewAllLabel}
        />

        <div class="grid gap-6 md:grid-cols-3">
          {recentPosts.map(post => (
            <BlogPostCard post={post} techMap={techMap} />
          ))}
        </div>
      </section>
    )
  }

  <!-- Contact Section -->
  <CTASection />
</MainLayout>
