---
import MainLayout from '@/layouts/main-layout.astro';
import HeroSection from '@/components/organisms/sections/HeroSection.astro';
import BlogSection from '@/components/organisms/sections/BlogSection.astro';
import CTASection from '@/components/organisms/sections/CTASection.astro';
import { getCollection } from 'astro:content';
import { createTechMap } from '@/utils/tech-lookup';
import pages from '@/content/site/pages.json';

const posts = await getCollection('blog');
const technologies = await getCollection('technologies');
const techMap = createTechMap(technologies);
const currentDate = new Date();

const postsToShow = posts
  .filter(post => post.data.publishDate !== null)
  .filter(post => post.data.publishDate! <= currentDate)
  .sort((a, b) => b.data.publishDate!.getTime() - a.data.publishDate!.getTime());
---

<MainLayout title={pages.blogIndex.metaTitle} description={pages.blogIndex.metaDescription}>
  <HeroSection
    variant="minimal"
    headline={pages.blogIndex.heading}
    description={pages.blogIndex.intro}
    class="py-8"
  />

  {postsToShow.length > 0 ? (
    <BlogSection
      title=""
      posts={postsToShow}
      techMap={techMap}
      variant="list"
      showTags
      class="animate-section py-0 max-w-4xl mx-auto"
    />
  ) : (
    <div class="py-12 text-center">
      <p class="text-foreground-muted">{pages.blogIndex.emptyState}</p>
    </div>
  )}

  <CTASection class="animate-section mt-12" />
</MainLayout>
