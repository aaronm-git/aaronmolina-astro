---
import MainLayout from '@/layouts/main-layout.astro';
import ProjectCard from '@/components/ProjectCard.astro';
import RoleCard from '@/components/RoleCard.astro';
import CTA from '@/components/CTA.astro';
import { getCollection } from 'astro:content';
import ProfilePicture from '@/images/profile.jpg';
import { Image } from 'astro:assets';
import { FaBriefcase, FaBookOpen, FaStar, FaArrowRight, FaPencil, FaCalendar } from 'react-icons/fa6';
import homepageContent from '@/content/site/homepage.json';
import pages from '@/content/site/pages.json';
import navigation from '@/content/site/navigation.json';

const posts = await getCollection('blog');
const currentDate = new Date();
const recentPosts = posts
  .filter(post => post.data.publishDate !== null)
  .filter(post => post.data.publishDate! <= currentDate)
  .sort((a, b) => b.data.publishDate!.getTime() - a.data.publishDate!.getTime())
  .slice(0, 3);

const roles = await getCollection('roles');
const organizations = await getCollection('organizations');

const orgBySlug = new Map(organizations.map((o) => [o.data.slug, o]));

const featuredRoles = roles
  .filter((r) => r.data.isActive !== false)
  .sort((a, b) => {
    // featured first
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    // then sortOrder
    if ((a.data.sortOrder ?? 0) !== (b.data.sortOrder ?? 0)) return (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0);
    // then by startDate (newest first)
    return b.data.startDate.getTime() - a.data.startDate.getTime();
  })
  .slice(0, 4);

const projects = await getCollection('projects');
const featuredProjects = projects
  .filter(project => project.data.isActive !== false)
  .sort((a, b) => {
    // featured first
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    if ((a.data.sortOrder ?? 0) !== (b.data.sortOrder ?? 0)) return (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0);
    return (b.data.completedOn?.getTime() || 0) - (a.data.completedOn?.getTime() || 0);
  })
  .slice(0, 3);

const yearsOfExperience = new Date().getFullYear() - homepageContent.yearsOfExperienceStartYear;
const heroDescription = homepageContent.hero.description.replaceAll('{yearsOfExperience}', String(yearsOfExperience));
---

<MainLayout>
  <!-- Hero Section -->
  <section class="my-16 text-center">
    <div class="hero-image mb-8 flex justify-center">
      <Image
        src={ProfilePicture}
        alt={navigation.brandAlt}
        class="border-border h-32 w-32 rounded-full border-2 object-cover object-[20%_40%] shadow-lg md:h-48 md:w-48"
        loading="eager"
      />
    </div>
    <h1 class="hero-title text-foreground mb-1 text-4xl font-bold md:mb-6 md:text-6xl">{homepageContent.hero.name}</h1>
    <p class="hero-subtitle text-foreground-muted mb-4 text-lg font-medium md:text-2xl">{homepageContent.hero.headline}</p>
    <p class="hero-description text-foreground-muted mx-auto max-w-3xl text-base leading-relaxed md:text-lg">
      {heroDescription}
    </p>
    <div class="mt-8 flex flex-col items-center justify-center gap-4 max-md:gap-2 md:flex-row">
      <a
        href="/projects"
        class="hero-cta bg-secondary hover:bg-secondary-hover text-on-secondary inline-flex items-center gap-2 rounded-lg px-8 py-3 font-medium transition-colors"
      >
        <FaBriefcase className="icon-sm" />
        {pages.home.buttons.viewWorkLabel}
      </a>
      <a href="/blog" class="hero-cta bg-primary hover:bg-primary-hover text-on-primary inline-flex items-center gap-2 rounded-lg px-8 py-3 font-medium transition-colors">
        <FaBookOpen className="icon-sm" />
        {pages.home.buttons.readBlogLabel}
      </a>
    </div>
  </section>

  <!-- Featured Projects Section -->
  <section class="animate-section mb-16">
    <div class="mb-8 flex items-center justify-between">
      <h2 class="text-foreground flex items-center gap-3 text-2xl font-bold md:text-3xl">
        <FaStar className="text-secondary icon-base" />
        {pages.home.sections.featuredProjectsTitle}
      </h2>
      <a href="/projects" class="text-secondary hover:text-secondary-hover group hidden items-center gap-1 font-medium md:flex">
        {pages.home.sections.featuredProjectsViewAllLabel} <FaArrowRight className="icon-sm transition-transform group-hover:translate-x-1" />
      </a>
    </div>

    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {featuredProjects.map(project => <ProjectCard project={project} showCompletedDate={false} showViewProjectLink={false} />)}
    </div>

    <a href="/projects" class="text-secondary hover:text-secondary-hover mt-6 flex items-center justify-end gap-2 font-medium md:hidden">
      {pages.home.sections.featuredProjectsViewAllLabel} <FaArrowRight className="icon-sm" />
    </a>
  </section>

  <!-- Experience Section -->
  <section class="animate-section mb-16">
    <div class="mb-8 flex items-center justify-between">
      <h2 class="text-foreground flex items-center gap-3 text-2xl font-bold md:text-3xl">
        <FaBriefcase className="text-secondary icon-base" />
        {pages.home.sections.experienceTitle}
      </h2>
      <a href="/experience" class="text-secondary hover:text-secondary-hover group hidden items-center gap-1 font-medium md:flex">
        {pages.home.sections.experienceViewAllLabel} <FaArrowRight className="icon-sm transition-transform group-hover:translate-x-1" />
      </a>
    </div>

    <div class="animate-content space-y-8">
      {featuredRoles.map((role) => <RoleCard role={role} organization={orgBySlug.get(role.data.organization)} showAllDetails={false} />)}
    </div>

    <a href="/experience" class="text-secondary hover:text-secondary-hover mt-6 flex items-center justify-end gap-2 font-medium md:hidden">
      {pages.home.sections.experienceViewAllLabel} <FaArrowRight className="icon-sm" />
    </a>
  </section>

  <!-- Recent Blog Posts -->
  {
    recentPosts.length > 0 && (
      <section class="animate-section mb-16">
        <div class="mb-8 flex items-center justify-between">
          <h2 class="text-foreground flex items-center gap-3 text-2xl font-bold md:text-3xl">
            <FaPencil className="text-secondary icon-base" />
            {pages.home.sections.latestArticlesTitle}
          </h2>
          <a href="/blog" class="text-secondary hover:text-secondary-hover group flex items-center gap-1 font-medium">
            {pages.home.sections.latestArticlesViewAllLabel} <FaArrowRight className="icon-sm transition-transform group-hover:translate-x-1" />
          </a>
        </div>

        <div class="grid gap-6 md:grid-cols-3">
          {recentPosts.map(post => (
            <article class="animate-content bg-surface border-border flex flex-col justify-between rounded-lg border p-6 shadow-md transition-shadow hover:shadow-lg">
              <div>
                <h3 class="text-foreground mb-3 line-clamp-2 h-14 text-lg font-semibold">
                  <a title={post.data.title} href={`/blog/${post.data.slug}`} class="hover:text-secondary transition-colors">
                    {post.data.title}
                  </a>
                </h3>
                <div class="text-foreground-muted mb-3 flex items-center gap-2 text-sm">
                  <FaCalendar className="size-icon-sm" />
                  <time datetime={post.data.publishDate?.toISOString()}>
                    {post.data.publishDate?.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                    })}
                  </time>
                </div>
                {post.data.description && <p class="text-foreground-muted mb-4 text-sm leading-relaxed">{post.data.description}</p>}
              </div>
              <a href={`/blog/${post.data.slug}`} class="text-secondary hover:text-secondary-hover group flex items-center gap-1 font-medium">
                Read More <FaArrowRight className="icon-sm transition-transform group-hover:translate-x-1" />
              </a>
            </article>
          ))}
        </div>
      </section>
    )
  }

  <!-- Contact Section -->
  <CTA />
</MainLayout>
