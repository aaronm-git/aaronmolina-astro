---
import type { IconType } from 'react-icons';
import { getIcon } from '@/lib/icons';
import { cn } from '@/lib/cn';

type ButtonVariant = 'primary' | 'secondary' | 'outline' | 'ghost' | 'link' | 'tactile' | 'glass';
type ButtonSize = 'xs' | 'sm' | 'base' | 'lg' | 'xl';
type ButtonRounded = 'none' | 'sm' | 'base' | 'lg' | 'full';

interface Props {
  /** URL for link buttons (renders as <a>) */
  href?: string;
  /** Visual variant */
  variant?: ButtonVariant;
  /** Button size */
  size?: ButtonSize;
  /** Icon name (uses getIcon to resolve) */
  icon?: string;
  /** Direct icon component */
  iconComponent?: IconType;
  /** Icon position */
  iconPosition?: 'left' | 'right' | 'only';
  /** Open link in new tab */
  external?: boolean;
  /** Full width button */
  fullWidth?: boolean;
  /** Disabled state */
  disabled?: boolean;
  /** Loading state */
  loading?: boolean;
  /** Button type (for form buttons) */
  type?: 'button' | 'submit' | 'reset';
  /** Border radius */
  rounded?: ButtonRounded;
  /** 3D depth effect */
  depth?: boolean;
  /** Bouncy hover animation */
  bounce?: boolean;
  /** Glow effect on hover */
  glow?: boolean;
  /** Additional CSS classes */
  class?: string;
  /** Aria label */
  ariaLabel?: string;
}

const {
  href,
  variant = 'primary',
  size = 'base',
  icon,
  iconComponent,
  iconPosition = 'left',
  external = false,
  fullWidth = false,
  disabled = false,
  loading = false,
  type = 'button',
  rounded = 'base',
  depth = false,
  bounce = false,
  glow = false,
  class: className = '',
  ariaLabel,
} = Astro.props;

// Resolve icon
const IconComponent = iconComponent || (icon ? getIcon(icon) : null);
const showIcon = IconComponent && !loading;
const iconOnly = iconPosition === 'only';

// Base classes
const baseClasses = 'inline-flex items-center justify-center font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-background';

// Variant classes
const variantClasses: Record<ButtonVariant, string> = {
  primary: 'bg-primary hover:bg-primary-hover text-on-primary focus:ring-primary',
  secondary: 'bg-secondary hover:bg-secondary-hover text-on-secondary focus:ring-secondary',
  outline: 'bg-transparent border border-border text-foreground hover:bg-muted focus:ring-border',
  ghost: 'bg-transparent text-foreground hover:bg-muted focus:ring-muted',
  link: 'bg-transparent text-secondary hover:text-secondary-hover underline-offset-4 hover:underline p-0 focus:ring-secondary',
  tactile: 'btn-tactile bg-primary text-on-primary focus:ring-primary',
  glass: 'btn-glass backdrop-blur-md bg-white/10 border border-white/20 text-foreground hover:bg-white/20 focus:ring-white/30',
};

// Size classes
const sizeClasses: Record<ButtonSize, string> = {
  xs: 'h-7 px-2 text-xs gap-1',
  sm: 'h-8 px-3 text-sm gap-1.5',
  base: 'h-10 px-4 text-sm gap-2',
  lg: 'h-12 px-6 text-base gap-2.5',
  xl: 'h-14 px-8 text-lg gap-3',
};

// Icon-only size classes
const iconOnlySizeClasses: Record<ButtonSize, string> = {
  xs: 'h-7 w-7',
  sm: 'h-8 w-8',
  base: 'h-10 w-10',
  lg: 'h-12 w-12',
  xl: 'h-14 w-14',
};

// Rounded classes
const roundedClasses: Record<ButtonRounded, string> = {
  none: 'rounded-none',
  sm: 'rounded',
  base: 'rounded-md',
  lg: 'rounded-lg',
  full: 'rounded-full',
};

// Icon size based on button size
const iconSizeClasses: Record<ButtonSize, string> = {
  xs: 'w-3 h-3',
  sm: 'w-3.5 h-3.5',
  base: 'w-4 h-4',
  lg: 'w-5 h-5',
  xl: 'w-6 h-6',
};

// Build combined classes
const combinedClasses = cn(
  baseClasses,
  variantClasses[variant],
  variant !== 'link' ? (iconOnly ? iconOnlySizeClasses[size] : sizeClasses[size]) : 'gap-1',
  roundedClasses[rounded],
  disabled && 'opacity-50 cursor-not-allowed pointer-events-none',
  fullWidth && 'w-full',
  depth && 'btn-depth',
  bounce && 'btn-bounce',
  glow && 'btn-glow',
  className,
);

const iconClass = iconSizeClasses[size];
const isLink = !!href;

// Link-specific props
const linkProps = isLink ? {
  href,
  target: external ? '_blank' : undefined,
  rel: external ? 'noopener noreferrer' : undefined,
} : {};

// Button-specific props
const buttonProps = !isLink ? {
  type,
  disabled: disabled || loading,
} : {};
---

{isLink ? (
  <a
    {...linkProps}
    class={combinedClasses}
    aria-label={ariaLabel}
  >
    {loading && (
      <svg class={cn(iconClass, 'animate-spin')} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    )}
    {iconPosition === 'left' && showIcon && (
      <IconComponent className={cn(iconClass, variant === 'link' && 'transition-transform group-hover:-translate-x-1')} />
    )}
    {!iconOnly && <slot />}
    {(iconPosition === 'right' || iconOnly) && showIcon && (
      <IconComponent className={cn(iconClass, variant === 'link' && 'transition-transform group-hover:translate-x-1')} />
    )}
  </a>
) : (
  <button
    {...buttonProps}
    class={combinedClasses}
    aria-label={ariaLabel}
  >
    {loading && (
      <svg class={cn(iconClass, 'animate-spin')} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    )}
    {iconPosition === 'left' && showIcon && (
      <IconComponent className={iconClass} />
    )}
    {!iconOnly && <slot />}
    {(iconPosition === 'right' || iconOnly) && showIcon && (
      <IconComponent className={iconClass} />
    )}
  </button>
)}

<style>
  /* Tactile button styles */
  .btn-tactile {
    --depth: 4px;
    box-shadow:
      0 var(--depth) 0 color-mix(in srgb, var(--primary) 80%, black),
      0 var(--depth) 10px rgba(0,0,0,0.2);
    transform: translateY(0);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .btn-tactile:hover {
    transform: translateY(-2px);
    box-shadow:
      0 calc(var(--depth) + 2px) 0 color-mix(in srgb, var(--primary) 80%, black),
      0 calc(var(--depth) + 2px) 15px rgba(0,0,0,0.25);
  }

  .btn-tactile:active {
    transform: translateY(var(--depth));
    box-shadow:
      0 0 0 color-mix(in srgb, var(--primary) 80%, black),
      0 2px 5px rgba(0,0,0,0.15);
  }

  /* Depth modifier */
  .btn-depth {
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .btn-depth:hover {
    box-shadow:
      0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  /* Bounce modifier */
  .btn-bounce {
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .btn-bounce:hover {
    transform: scale(1.02) translateY(-1px);
  }

  .btn-bounce:active {
    transform: scale(0.98);
  }

  /* Glow modifier */
  .btn-glow:hover {
    box-shadow: 0 0 20px color-mix(in srgb, var(--primary) 50%, transparent);
  }

  /* Glass button */
  .btn-glass {
    backdrop-filter: blur(12px);
  }
</style>
