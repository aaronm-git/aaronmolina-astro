---
import MainLayout from '@/layouts/main-layout.astro';
import HeroSection from '@/components/organisms/sections/HeroSection.astro';
import StatsSection from '@/components/organisms/sections/StatsSection.astro';
import SkillsSection from '@/components/organisms/sections/SkillsSection.astro';
import ServicesSection from '@/components/organisms/sections/ServicesSection.astro';
import FeaturesSection from '@/components/organisms/sections/FeaturesSection.astro';
import ProjectsSection from '@/components/organisms/sections/ProjectsSection.astro';
import ExperienceSection from '@/components/organisms/sections/ExperienceSection.astro';
import BlogSection from '@/components/organisms/sections/BlogSection.astro';
import CTASection from '@/components/organisms/sections/CTASection.astro';
import Badge from '@/components/atoms/Badge.astro';
import { getCollection } from 'astro:content';
import { createTechMap } from '@/utils/tech-lookup';
import ProfilePicture from '@/images/profile.jpg';
import homepageContent from '@/content/site/homepage.json';
import navigation from '@/content/site/navigation.json';

// Fetch collections
const posts = await getCollection('blog');
const technologies = await getCollection('technologies');
const techMap = createTechMap(technologies);
const roles = await getCollection('roles');
const organizations = await getCollection('organizations');
const projects = await getCollection('projects');

// Process blog posts
const currentDate = new Date();
const recentPosts = posts
  .filter(post => post.data.publishDate !== null)
  .filter(post => post.data.publishDate! <= currentDate)
  .sort((a, b) => b.data.publishDate!.getTime() - a.data.publishDate!.getTime())
  .slice(0, 3);

// Process organizations
const orgBySlug = new Map(organizations.map((o) => [o.data.slug, o]));
const now = Date.now();

// Process roles
const featuredRoles = roles
  .filter((r) => r.data.isActive !== false)
  .sort((a, b) => {
    const aCurrent = Boolean(a.data.current);
    const bCurrent = Boolean(b.data.current);

    if (aCurrent && bCurrent) {
      const aDuration = (a.data.endDate?.getTime() ?? now) - a.data.startDate.getTime();
      const bDuration = (b.data.endDate?.getTime() ?? now) - b.data.startDate.getTime();
      if (aDuration !== bDuration) return aDuration - bDuration;
    } else {
      if (aCurrent && !bCurrent) return -1;
      if (!aCurrent && bCurrent) return 1;
    }

    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    if ((a.data.sortOrder ?? 0) !== (b.data.sortOrder ?? 0)) return (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0);
    return b.data.startDate.getTime() - a.data.startDate.getTime();
  })
  .slice(0, 3);

// Process projects
const featuredProjects = projects
  .filter(project => project.data.isActive !== false)
  .sort((a, b) => {
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    if ((a.data.sortOrder ?? 0) !== (b.data.sortOrder ?? 0)) return (a.data.sortOrder ?? 0) - (b.data.sortOrder ?? 0);
    return (b.data.completedOn?.getTime() || 0) - (a.data.completedOn?.getTime() || 0);
  })
  .slice(0, 3);

// Compute dynamic content
const yearsOfExperience = new Date().getFullYear() - homepageContent.yearsOfExperienceStartYear;
const heroDescription = homepageContent.hero.description.replaceAll('{yearsOfExperience}', String(yearsOfExperience));

// Process stats with dynamic year
const statsItems = homepageContent.stats.items.map(item => ({
  ...item,
  value: String(item.value).replaceAll('{yearsOfExperience}', String(yearsOfExperience))
}));
---

<MainLayout
  title={homepageContent.meta.title}
  description={homepageContent.meta.description}
>
  <!-- Hero Section -->
  <HeroSection
    variant="profile"
    avatar={ProfilePicture}
    avatarAlt={navigation.brandAlt}
    headline={homepageContent.hero.name}
    subheadline={homepageContent.hero.headline}
    description={heroDescription}
    primaryCta={{
      label: homepageContent.buttons.viewWorkLabel,
      href: '/projects',
      icon: 'briefcase',
      variant: 'secondary',
    }}
    secondaryCta={{
      label: homepageContent.buttons.hireMeLabel,
      href: '/contact',
      icon: 'arrowRight',
      variant: 'primary',
    }}
    showBubbles={false}
    class="my-16 py-0"
  >
    <div class="mt-4 flex flex-wrap justify-center gap-2">
      <Badge label={homepageContent.hero.subheadline} variant="primary" size="sm" />
      <Badge label={homepageContent.hero.location} variant="outline" size="sm" />
      <Badge label={homepageContent.hero.availability} variant="secondary" size="sm" />
    </div>
  </HeroSection>

  <!-- Stats Section -->
  <StatsSection
    stats={statsItems}
    variant="cards"
    columns={4}
    highlight
    class="animate-section mb-16"
  />

  <!-- Services Section -->
  <ServicesSection
    title={homepageContent.services.title}
    subtitle={homepageContent.services.subtitle}
    services={homepageContent.services.items}
    variant="grid"
    columns={2}
    class="animate-section mb-16 bg-muted/30 rounded-2xl"
  />

  <!-- Tech Stack Section -->
  <SkillsSection
    title={homepageContent.techStack.title}
    subtitle={homepageContent.techStack.subtitle}
    categories={homepageContent.techStack.categories}
    techMap={techMap}
    variant="grouped"
    columns={2}
    class="animate-section mb-16"
  />

  <!-- Featured Projects Section -->
  <ProjectsSection
    title={homepageContent.featuredProjects.title}
    projects={featuredProjects}
    cta={{
      label: homepageContent.featuredProjects.viewAllLabel,
      href: homepageContent.featuredProjects.viewAllHref,
    }}
    class="animate-section mb-16"
  />

  <!-- Why Work With Me Section -->
  <FeaturesSection
    title={homepageContent.valueProps.title}
    features={homepageContent.valueProps.items}
    variant="cards"
    columns={2}
    class="animate-section mb-16 bg-muted/30 rounded-2xl"
  />

  <!-- Experience Section -->
  <ExperienceSection
    title={homepageContent.experience.title}
    roles={featuredRoles}
    organizations={orgBySlug}
    variant="cards"
    cta={{
      label: homepageContent.experience.viewAllLabel,
      href: homepageContent.experience.viewAllHref,
    }}
    class="animate-section mb-16"
  />

  <!-- Blog Section -->
  {recentPosts.length > 0 && (
    <BlogSection
      title={homepageContent.blog.title}
      subtitle={homepageContent.blog.subtitle}
      posts={recentPosts}
      techMap={techMap}
      cta={{
        label: homepageContent.blog.viewAllLabel,
        href: homepageContent.blog.viewAllHref,
      }}
      class="animate-section mb-16"
    />
  )}

  <!-- CTA Section -->
  <CTASection
    title={homepageContent.cta.title}
    description={homepageContent.cta.description}
    buttonLabel={homepageContent.cta.primaryButton.label}
    buttonHref={homepageContent.cta.primaryButton.href}
  />
</MainLayout>
